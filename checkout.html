<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>UTR | Checkout</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        /* Style for buttons to keep them consistent */
        .button {
            padding: 10px;
            margin: 5px;
            border: none;
            cursor: pointer;
        }

        .button:hover {
            opacity: 0.9;
        }

        .selected {
            background-color: var(--hover-color);
        }

        .unselected {
            background-color: var(--secondary-color);
        }
    </style>
    <script>
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let current_user_index = parseInt(localStorage.getItem('current_user_index') || -1);
        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        // Function to handle toggling order mode (pickup or delivery)
        function toggleMode(mode) {
            localStorage.setItem('orderMode', mode);
            toggleAddressFields();

            // Highlight the selected mode
            document.getElementById('pickup-button').className = mode === 'pickup' ? 'button selected' : 'button unselected';
            document.getElementById('delivery-button').className = mode === 'delivery' ? 'button selected' : 'button unselected';
            
            // Update the order summary whenever the mode changes
            updateOrderSummary();
        }

        // Toggle visibility of address fields based on order mode
        function toggleAddressFields() {
            const orderMode = localStorage.getItem('orderMode');
            const addressFields = document.getElementById('address-fields');

            if (orderMode === 'pickup') {
                addressFields.style.display = 'none';
            } else {
                addressFields.style.display = 'block';
            }
        }

        // Function to validate payment and handle order submission
        function validatePayment(event) {
            event.preventDefault();

            const orderMode = localStorage.getItem('orderMode');
            const address = document.getElementById("address").value;
            const city = document.getElementById("city").value;
            const postcode = document.getElementById("postcode").value;

            // Store the delivery details in localStorage if order mode is 'delivery'
            if (orderMode !== 'pickup') {
                if (address.length === 0 || city.length === 0 || postcode.length === 0) {
                    alert('Please fill out all address fields for delivery.');
                    return;
                }

                const deliveryDetails = {
                    address: address,
                    city: city,
                    postcode: postcode
                };
                localStorage.setItem('deliveryDetails', JSON.stringify(deliveryDetails));
            }

            if (document.getElementById("cash-chosen") == null) {
                // Validate card payment details if 'Card' payment is selected
                const card_number = document.getElementById("card-number").value;
                const card_name = document.getElementById("card-name").value;
                const expiration_date = document.getElementById("expiration-date").value;
                const cvv = document.getElementById("cvv").value;

                if (card_number.length === 0 || card_name.length === 0 || expiration_date.length === 0 || cvv.length === 0) {
                    alert('Please fill out all card payment details.');
                    return;
                }
            }

            // If cash payment is selected, no card details are needed
            increaseOrders();
            document.getElementById("pay-confirmed").innerText = "Payment confirmed. Tracking your order...";
            
            // Redirect to the trackOrder.html page after 2 seconds
            setTimeout(function () {
                window.location.href = "trackOrder.html";
            }, 2000);
        }

        // Function to switch payment method (card or cash)
        function switchPaymentMethod(payment_method) {
            if (payment_method === "card") {
                document.getElementById("payment-information").innerHTML =
                    "<div class='checkout-information'><label for='card-number'>Card Number</label><input type='text' id='card-number' placeholder='XXXX XXXX XXXX XXXX' required></div>" +
                    "<div class='checkout-information'><label for='card-name'>Name on Card</label><input type='text' id='card-name' placeholder='Jane Doe' required></div>" +
                    "<div class='checkout-information'><label for='expiration-date'>Expiration Date</label><input type='month' id='expiration-date' required></div>" +
                    "<div class='checkout-information'><label for='cvv'>Security Code (CVV/CVC)</label><input type='text' id='cvv' maxlength='4' placeholder='100' required></div>";

                document.getElementById("card-method").className = 'button selected';
                document.getElementById("cash-method").className = 'button unselected';
            } else {
                document.getElementById("payment-information").innerHTML =
                    "<p id='cash-chosen'>Please prepare the required amount and await your delivery.</p>";

                document.getElementById("cash-method").className = 'button selected';
                document.getElementById("card-method").className = 'button unselected';
            }
        }

        // Function to calculate subtotal and update order summary
        function updateOrderSummary() {
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });

            document.getElementById('subtotal').innerText = `$${subtotal.toFixed(2)}`;

            // Get the order mode
            const orderMode = localStorage.getItem('orderMode') || 'delivery';
            
            // Set delivery fee based on order mode
            let deliveryFee = orderMode === 'pickup' ? 0 : 2.99;

            // Update the delivery fee in the summary
            document.getElementById('delivery-fee').innerText = `$${deliveryFee.toFixed(2)}`;

            // Assuming service fee is fixed
            let serviceFee = 1.75;

            // Calculate total
            let total = subtotal + deliveryFee + serviceFee;
            document.getElementById('total').innerText = `$${total.toFixed(2)}`;
        }

        function increaseOrders() {
            if (current_user_index !== -1 && users[current_user_index]) {
                users[current_user_index].orders = (users[current_user_index].orders || 0) + 1;

                if (users[current_user_index].orders === 3) {
                    addAchievement(2);
                } else if (users[current_user_index].orders === 6) {
                    addAchievement(3);
                }

                localStorage.setItem("users", JSON.stringify(users));
            }
        }

        function addAchievement(achievementId) {
            if (current_user_index !== -1 && users[current_user_index]) {
                users[current_user_index].achievements = users[current_user_index].achievements || [];
                users[current_user_index].achievements.push(achievementId);
            }
        }

        // Call toggleAddressFields and update order summary on page load
        window.onload = function() {
            const orderMode = localStorage.getItem('orderMode') || 'delivery';
            toggleMode(orderMode);
            toggleAddressFields();
            updateOrderSummary();
        };
    </script>
</head>

<body>
    <header>
        <nav>
            <ul>
                <div id="logo">UTR</div>
                <li><a href="home.html">Home</a></li>
                <li><a href="locations.html">Locations</a></li>
                <li><a href="Food & Beverage.html">Food & Beverage</a></li>
                <li><a href="Gas & Go.html">Gas & Go</a></li>
                <li><a href="account.html" id="login-link">Account</a></li>
                <li><a href="Achievement.html">Achievement</a></li>
                <a href="cart.html" id="cart-link">
                    <img src="images/cart.png" alt="Cart Icon" id="cart-icon"/>
                </a>
            </ul>
        </nav>
    </header>

    <main>
        <div>
            <h1>Payment Information</h1>
            
            <form id="checkout-container" onsubmit="validatePayment(event)">
                <div>
                    <a href="cart.html">Return to Cart</a>
                    
                    <!-- Pickup and Delivery selection buttons -->
                    <div id="order-mode-selection">
                        <button type="button" id="pickup-button" class="button" onclick="toggleMode('pickup')">Pickup</button>
                        <button type="button" id="delivery-button" class="button" onclick="toggleMode('delivery')">Delivery</button>
                    </div>
                    
                    <h2>Enter Details</h2>
                    <div id="address-fields">
                        <div class="checkout-information">
                            <label for="address">Address</label>
                            <input type="text" id="address" placeholder="123 Main Street">
                        </div>

                        <div class="checkout-information">
                            <label for="city">City/Suburb</label>
                            <input type="text" id="city" placeholder="Mawson Lakes">
                        </div>

                        <div class="checkout-information">
                            <label for="postcode">Postcode</label>
                            <input type="text" id="postcode" maxlength="4" placeholder="5000">
                        </div>
                    </div>
                </div>
    
                <div>
                    <h2>Payment Method</h2>
                    <div id="payment-method">
                        <button type="button" id="card-method" class="button" onclick="switchPaymentMethod('card')">Card</button>
                        <button type="button" id="cash-method" class="button" onclick="switchPaymentMethod('cash')">Cash</button>
                    </div>

                    <div id="payment-information">
                        <!-- Default to card payment fields -->
                        <div class="checkout-information">
                            <label for="card-number">Card Number</label>
                            <input type="text" id="card-number" placeholder="XXXX XXXX XXXX XXXX">
                        </div>
                        
                        <div class="checkout-information">
                            <label for="card-name">Name on Card</label>
                            <input type="text" id="card-name" placeholder="Jane Doe">
                        </div>

                        <div class="checkout-information">
                            <label for="expiration-date">Expiration Date</label>
                            <input type="month" id="expiration-date">
                        </div>

                        <div class="checkout-information">
                            <label for="cvv">Security Code (CVV/CVC)</label>
                            <input type="text" id="cvv" maxlength="4" placeholder="100">
                        </div>
                    </div>
                </div>

                <div class="summary">
                    <h2>Order Summary</h2>
                    <p>Subtotal: <span id="subtotal">$0.00</span></p>
                    <p>Delivery Fee: <span id="delivery-fee">$2.99</span></p>
                    <p>Service Fee: <span>$1.75</span></p>
                    <div class="total">
                        <p>Total: <span id="total">$12.24</span></p>
                    </div>
                </div>

                <button type="submit" id="pay-button" class="button">Pay Now</button>
                <p id="pay-confirmed"></p>
            </form>
        </div>
    </main>

    <footer>
        &copy; Copyright UTR Pty Ltd, 2024. All rights reserved.
    </footer>
</body>
</html>
